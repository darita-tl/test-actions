name: Conditional Matrix Workflow

on:
  workflow_dispatch:
    inputs:
      release-stories:
        description: "Release stories?"
        required: false
        type: boolean
        default: false
      release-homepages:
        description: "Release homepages?"
        required: false
        type: boolean
        default: false
      release-contracts:
        description: "Release contracts?"
        required: false
        type: boolean
        default: false
      increase:
        description: "Release version"
        required: true
        type: choice
        options:
          - skip
          - patch
          - minor
          - major
        default: skip
  push:
    branches:
      - main

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Build matrix JSON
        id: set-matrix
        uses: actions/github-script@v6
        with:
          script: |
            const allTasks = ['stories', 'homepages', 'contracts'];
            const eventName = process.env.GITHUB_EVENT_NAME;
            let selectedTasks = [];
            
            if (eventName === 'push') {
              // On push to main: include everything
              selectedTasks = allTasks;
            } else {
              // On workflow_dispatch: include only checked inputs
              console.log('Inputs:', github.event);
              if ('${{github.event.inputs.release-stories}}' === 'true') selectedTasks.push('stories');
              if ('${{github.event.inputs.release-homepages}}' === 'true') selectedTasks.push('homepages');
              if ('${{github.event.inputs.release-contracts}}' === 'true') selectedTasks.push('contracts');
            }
            
            const matrixInclude = selectedTasks.map(task => {
              let app_type;
              if (task === 'stories' || task === 'homepages') {
                app_type = 'api';
              } else if (task === 'contracts') {
                app_type = 'npm_package';
              }
              return { task: task, app_type: app_type };
            });
            
            core.setOutput('matrix', JSON.stringify({ include: matrixInclude }));

  run-on-matrix:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    steps:
      - name: Execute ${{ matrix.task }} (${{ matrix.app_type }})
        if: ${{ matrix.task }}
        run: |
          echo "▶️ Running ${{ matrix.task }} (${{ matrix.app_type }})"
          case "${{ matrix.task }}" in
            stories)  echo "→ Releasing stories (${{ matrix.app_type }}) with ${{github.event.inputs.increase}} version";;
            homepages)   echo "→ Releasing homepages (${{ matrix.app_type }}) with ${{github.event.inputs.increase}} version";;
            contracts)  echo "→ Releasing contracts (${{ matrix.app_type }}) with ${{github.event.inputs.increase}} version";;
          esac
